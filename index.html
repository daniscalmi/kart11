<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>Classifiche Gara</title>

    <style>
      /* üåü Stile generale */
body {
    font-family: Arial, sans-serif;
    background-color: #ffffff; /* Sfondo bianco */
    color: #333333; /* Testo scuro */
    text-align: center;
}

        /* üìå Allineamento logo a sinistra */
        .logo {
            max-width: 600px;
            height: auto;
            display: block;
            margin-right: 30px; /* Mantiene spazio tra logo e contenuto */
            margin-left: 0; /* Allineato a sinistra */
        }

        /* üìå Allinea il contenitore superiore */
        .top-container {
            display: flex;
            justify-content: flex-start; /* Allinea gli elementi a sinistra */
            align-items: center;
            padding: 20px 5%;
            flex-wrap: wrap;
        }

/* üî• Contenitore informazioni */
.info-container {
    text-align: center;
}

/* üî• Stile per il giro pi√π veloce */
.fastest-lap {
    font-size: 22px; /* Pi√π grande */
    font-weight: bold;
    color: #ff0000; /* Rosso acceso */
    margin-bottom: 10px;
}

/* üìå Tabella ultimi 5 kart (ora centrata meglio) */
.latest-karts-table {
    width: 350px; /* Leggermente pi√π larga */
    margin: 0 auto; /* Centrata */
    border-collapse: collapse;
    background-color: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    text-align: center;
    margin-top: 15px;
}

.latest-karts-table th, .latest-karts-table td {
    padding: 7px;
    border: 1px solid #ddd;
}

.latest-karts-table th {
    background-color: #007bff;
    color: #ffffff;
    font-weight: bold;
}

.latest-karts-table tbody tr:nth-child(even) {
    background-color: #f1f1f1;
}

/* üî• Pi√π spazio tra la tabella ultimi 5 e le classifiche */
.classifica-container {
    margin-top: 30px;
}

.tab-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin: 20px auto;
    max-width: 1000px;
}

/* Stile base per tutti i bottoni */
.tab-button {
  padding: 10px 16px;
  border: none;
  border-radius: 30px;
  color: black; /* scritte nere */
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  background-color: yellow; /* bottoni gialli */
}

/* Effetto hover */
.tab-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  background-position: 100% 0;
}

/* Stile per il bottone attivo */
.tab-button.active {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Varianti di colore per ciascuna categoria */
.tab-button.team {
  background: linear-gradient(to right, #a8e063, #56ab2f);
}

.tab-button.team.active {
  background: linear-gradient(to right, #56ab2f, #a8e063);
}

.tab-button.donne {
  background: linear-gradient(to right, #ff9a9e, #fecfef);
  color: black !important; /* forza l'applicazione del colore nero */
}


.tab-button.donne.active {
  background: linear-gradient(to right, #fecfef, #ff9a9e);
}

.tab-button.senior {
  background: linear-gradient(to right, #2980b9, #3498db); /* blu sfumato */
  color: white !important; /* testo bianco */
}

.tab-button.senior.active {
  background: linear-gradient(to right, #3498db, #2980b9); /* inverti per effetto active */
  color: white !important; /* testo bianco anche quando attivo */
}


.tab-button.ps {
  background: linear-gradient(to right, #fceabb, #f8b500);
}

.tab-button.ps.active {
  background: linear-gradient(to right, #f8b500, #fceabb);
}
.tab-button.generale {
  background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
  color: white;
}

.tab-button.generale.active {
  background: linear-gradient(to right, #203a43, #2c5364, #0f2027);
  color: white;
}





.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* üìå Stile tabella Classifiche */
table {
    width: 90%;
    margin: auto;
    border-collapse: collapse;
    background-color: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

th, td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}

.btn-chiudi-popup {
    background-color: #cc3333;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 15px;
    font-weight: bold;
    border-radius: 6px;
    margin-top: 20px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease;
}

.btn-chiudi-popup:hover {
    background-color: #a60000;
}


th {
    background-color: #007bff;
    color: #ffffff;
    font-weight: bold;
}

tbody tr:nth-child(even) {
    background-color: #f1f1f1;
}

tbody tr:hover {
    background-color: #d4e4ff;
    color: #000;
}
/* üìå STILE CLASSIFICA TEAM */
.team-table {
    width: 90%;
    margin: auto;
    border-collapse: collapse;
    background-color: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

.concorrente-donna-senior {
   background-color: #f5b25c;
    color: black;
    padding: 2px 6px;
    border-radius: 4px;
}


.team-table th, .team-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}

/* üèÜ TESTA DELLA CLASSIFICA TEAM */
.team-table th {
    background-color: #007bff; /* Blu acceso */
    color: #ffffff;
    font-weight: bold;
}

/* üìå Alternanza colori righe */
.team-table tbody tr:nth-child(even) {
    background-color: #f1f1f1;
}

/* üìå Hover sulle righe */
.team-table tbody tr:hover {
    background-color: #d4e4ff;
    color: #000;
}

/* üåü POSIZIONE E PUNTI - INGRANDITI */
.team-position, .punti-totali {
    font-size: 30px;
    font-weight: bold;
    color: #ff0000; /* Rosso acceso */
}

/* üèÜ NOME SQUADRA - GRANDE E GIALLO */
.team-name {
    font-size:30px; /* Pi√π grande */
    font-weight: bold;
    color: #006400; /* Giallo per squadre */
}

/* üèéÔ∏è PILOTI - PI√ô PICCOLI RISPETTO AL TEAM */
.team-pilot {
    font-size: 18px; /* Pi√π piccolo */
    margin-top: 3px;
}
        /* üìå Aggiunge spazio tra il logo e le tabelle */
        .info-container {
            text-align: center;
            margin-left: 100px; /* Sposta leggermente a destra le tabelle */
        }

        /* üìå Aggiunge spazio tra le tabelle */
        .fastest-lap-table,
        .latest-karts-table {
            margin-top: 20px; /* Spazio sopra le tabelle */
        }

/* üé® COLORI DIVERSI PER LE CATEGORIE */
.pilota-generale { color: #ff9900; } /* Arancione */
.pilota-donne { color: #ff69b4; } /* Rosa */
.pilota-senior { color: #007bff; } /* Blu */

        /* üìå Stile per la colorazione del numero concorrente */
        .concorrente-donna {
            background-color: #ff69b4; /* Rosa */
            font-weight: bold;
        }

        .concorrente-senior {
            background-color: #87CEFA; /* Azzurro */
            font-weight: bold;
        }

        .concorrente-generale {
            background-color: #FFD580; /* Arancio Chiaro */
            font-weight: bold;
        }

        /* üìå Stile per rendere Nome, Cognome e Tempo in grassetto */
        .bold-text {
            font-weight: bold;
        }

        #popupOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

#popup {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    z-index: 1000;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
}


        /* üìå Sfondo verde chiaro per la posizione nella classifica generale */
        .posizione-generale {
            background-color: #90EE90; /* Verde chiaro */
            font-weight: bold;
        }

        /* üìå Mantiene gli stili dei concorrenti */
        .concorrente-donna {
            background-color: #ff69b4; /* Rosa */
            font-weight: bold;
        }

        .concorrente-senior {
            background-color: #87CEFA; /* Azzurro */
            font-weight: bold;
        }

        .concorrente-generale {
            background-color: #FFD580; /* Arancio Chiaro */
            font-weight: bold;
        }

        /* üìå Stile per il popup */
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            background: white;
            border: 2px solid #007bff;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
        }

        /* üìå Sfondo trasparente dietro il popup */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* üìå Bottone "Chiudi" pi√π elegante */
        .popup button {
            display: block;
            width: 150px;
            margin: 20px auto 10px; /* Aggiunge spazio sotto la tabella */
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px; /* Angoli arrotondati */
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

            /* üìå Effetto Hover */
            .popup button:hover {
                background-color: #0056b3;
                transform: scale(1.05);
            }




        /* üìå Allinea la barra di ricerca a sinistra */
        .search-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Allinea tutto a sinistra */
            margin-bottom: 20px;
        }

            /* üìå Stile della scritta "Cerca Pilota" */
            .search-container label {
                font-size: 18px;
                font-weight: bold;
                margin-right: 10px;
            }

            /* üìå Stile per il campo di input */
            .search-container input {
                padding: 10px;
                font-size: 16px;
                width: 200px;
                border: 2px solid #007bff;
                border-radius: 5px;
                margin-right: 10px;
            }

            /* üìå Stile per il bottone di ricerca */
            .search-container button {
                padding: 10px 15px;
                font-size: 16px;
                font-weight: bold;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.3s, transform 0.2s;
            }

                /* üìå Effetto hover sul bottone */
                .search-container button:hover {
                    background-color: #0056b3;
                    transform: scale(1.05);
                }

        /* üìå Testo in grassetto per Posizione, Numero, Nome e Tempo in tutte le classifiche */
        table tbody tr td:nth-child(1), /* Posizione */
        table tbody tr td:nth-child(2), /* Numero */
        table tbody tr td:nth-child(3), /* Nome */
        table tbody tr td:nth-child(4), /* Nome */
        table tbody tr td:nth-child(5) /* Tempo */ {
            font-weight: bold;
        }
		
		.giri-7 { background-color: #f2f2f2; } /* Grigio */
.giri-6 { background-color: #ffffff; } /* Bianco */
.giri-5 { background-color: #f2f2f2; } /* Grigio */
.giri-4 { background-color: #ffffff; } /* Bianco */
.giri-3 { background-color: #f2f2f2; } /* Grigio */
.giri-2 { background-color: #ffffff; } /* Bianco */
.giri-1 { background-color: #f2f2f2; } /* Grigio */



        /* üìå Stile personalizzato per i bottoni delle classifiche */

        /* üî¥ Bottone Classifica Donne ‚Üí Rosa */
        .tab-button[onclick="apriTab('donne')"] {
            background-color: #ff69b4; /* Rosa */
            color: white;
        }

        /* üîµ Bottone Classifica Senior ‚Üí Azzurro Chiaro */
        .tab-button[onclick="apriTab('senior')"] {
            background-color: #87CEFA; /* Azzurro Chiaro */
            color: white;
        }

        /* üü¢ Bottone Classifica Team ‚Üí Verde Chiaro */
        .tab-button[onclick="apriTab('team')"] {
            background-color: #90EE90; /* Verde Chiaro */
            color: black;
        }

        /* üìå Bottone Classifica Donne ‚Üí Rosa */
        .tab-button[onclick="apriTab('donne')"] {
            background-color: #ff69b4; /* Rosa */
            color: white;
        }

        /* üìå Bottone Classifica Senior ‚Üí Azzurro Chiaro */
        .tab-button[onclick="apriTab('senior')"] {
            background-color: #87CEFA; /* Azzurro Chiaro */
            color: white;
        }

        /* üìå Bottone Classifica Team ‚Üí Verde Chiaro */
        .tab-button[onclick="apriTab('team')"] {
            background-color: #90EE90; /* Verde Chiaro */
            color: black;
        }

        /* üìå Bottoni delle Prove Speciali (PS1-PS7) ‚Üí Giallo */
        .tab-button[onclick="apriTab('ps1')"],
        .tab-button[onclick="apriTab('ps2')"],
        .tab-button[onclick="apriTab('ps3')"],
        .tab-button[onclick="apriTab('ps4')"],
        .tab-button[onclick="apriTab('ps5')"],
        .tab-button[onclick="apriTab('ps6')"],
        .tab-button[onclick="apriTab('ps7')"] {
            background-color: #FFD700; /* Giallo */
            color: black;
        }

        /* üìå Effetto Hover per tutti i bottoni */
        .tab-button:hover {
            opacity: 0.8;
        }


        /* üìå Effetto Hover per tutti i bottoni */
        .tab-button:hover {
            opacity: 0.8;
        }

        /* üìå Sfondo verde chiaro per la posizione nelle classifiche PS */
        .ps-table td:nth-child(1) { /* Posizione */
            background-color: #90EE90; /* Verde Chiaro */
            font-weight: bold;
        }

        /* üìå Colore del numero concorrente in base alla categoria */
        .ps-table .concorrente-donna {
            background-color: #ff69b4;
            font-weight: bold;
        }
        /* Rosa */
        .ps-table .concorrente-senior {
            background-color: #87CEFA;
            font-weight: bold;
        }
        /* Azzurro */
        .ps-table .concorrente-generale {
            background-color: #FFD580;
            font-weight: bold;
        }
        /* Arancio Chiaro */

        /* üìå Testo in grassetto per Numero, Nome, Cognome e Tempo */
        .ps-table td:nth-child(2), /* Numero */
        .ps-table td:nth-child(3), /* Nome */
        .ps-table td:nth-child(4), /* Cognome */
        .ps-table td:nth-child(5) /* Tempo */ {
            font-weight: bold;
        }


        /* üìå Sfondo verde chiaro per la posizione nelle classifiche Generale, PS, Donne e Senior */
        .ps-table td:nth-child(1),
        .team-table td:nth-child(1),
        .donne-table td:nth-child(1),
        .senior-table td:nth-child(1) {
            background-color: #90EE90; /* Verde Chiaro */
            font-weight: bold;
        }

        /* üìå Sfondo per i numeri nelle classifiche Donne e Senior */
        .donne-table .concorrente-donna {
            background-color: #ff69b4; /* Rosa */
            font-weight: bold;
        }

        .senior-table .concorrente-senior {
            background-color: #87CEFA; /* Azzurro Chiaro */
            font-weight: bold;
        }

        /* üìå Testo in grassetto per Numero, Nome, Cognome e Tempo */
        .ps-table td:nth-child(2), /* Numero */
        .ps-table td:nth-child(3), /* Nome */
        .ps-table td:nth-child(4), /* Cognome */
        .ps-table td:nth-child(5),
        .donne-table td:nth-child(2),
        .donne-table td:nth-child(3),
        .donne-table td:nth-child(4),
        .donne-table td:nth-child(5),
        .senior-table td:nth-child(2),
        .senior-table td:nth-child(3),
        .senior-table td:nth-child(4),
        .senior-table td:nth-child(5) {
            font-weight: bold;
        }


        /* üìå Stile per il messaggio sotto la classifica generale */
        .info-click-tempi {
            text-align: left;
            font-size: 20px;
            font-style: normal;
            color: #333;
            margin-bottom: 10px;
            margin-left: 5px; /* Leggera spaziatura a sinistra */
        }

        /* üìå Sfondo verde chiaro per la posizione nella classifica team */
        #classificaTeamBody tr td:first-child {
            background-color: #90EE90; /* Verde Chiaro */
            font-weight: bold;
        }

        /* üìå Sfondo giallo per la colonna dei punti */
        #classificaTeamBody tr td:last-child {
            background-color: #FFD700; /* Giallo */
            font-weight: bold;
        }
		.giro-veloce-row {
    background-color: #fff9c4 !important; /* Giallo chiaro */
    border: 2px solid red;
}



.punteggio-popup {
    color: green;
    font-weight: bold;
    font-size: 22px;
    font-family: inherit; /* eredita il font della pagina */
    margin-bottom: 10px;
}





    
.giroveloce-tag {
  display: inline-block;
  margin-left: 5px;
  font-size: 0.8em;
  background-color: #ff0000;
  color: white;
  padding: 1px 5px;
  border-radius: 5px;
}

.group-alt-0 {
    background-color: #ffffff; /* Bianco */
}

.group-alt-1 {
    background-color: #f2f2f2; /* Grigio chiaro */
}

</style>
</head>
<body>
    <!-- üèÅ LOGO e INFORMAZIONI -->
    <div class="top-container">
        <img src="logo.jpeg" alt="Logo Gara" class="logo">



        <div class="info-container">

            <!-- üìå Titolo per il giro pi√π veloce -->
            <h3>Giro Pi√π Veloce</h3>

            <!-- üìå Tabella per il giro pi√π veloce -->
            <table class="fastest-lap-table">
                <thead>
                    <tr>
                        <th>NR</th>
                        <th>Pilota</th>
                        <th>Tempo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="fastestLapNR">-</td>
                        <td id="fastestLapPilot">-</td>
                        <td id="fastestLapTime">-</td>
                    </tr>
                </tbody>
            </table>


            <!-- üìå Titolo per gli ultimi 5 arrivi -->
            <h3>Ultimi 5 Arrivi</h3><!-- üìå Titolo per gli ultimi 5 arrivi -->
            <!-- üìå Tabella ultimi 5 kart arrivati -->
            <table class="latest-karts-table">
                <thead>
                    <tr>
                        <th>NR</th>
                        <th>Pilota</th>
                        <th>Tempo</th>
                    </tr>
                </thead>
                <tbody id="latestKartsBody">
                    <!-- Ultimi 5 kart verranno caricati qui -->
                </tbody>
            </table>
<!-- Mini popup mobile -->
<style>
@keyframes fadeInScale {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}
</style>

<div id="mobilePopup" style="
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #007bff;
    color: white;
    padding: 30px 50px;
    font-size: 36px;
    font-weight: bold;
    border-radius: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    z-index: 10000;
    max-width: 95%;
    text-align: center;
    line-height: 1.7;
    animation: fadeInScale 0.3s ease-in-out;
">
    <div id="popupContent"></div>
    <button onclick="chiudiPopupMobile()" style="
        margin-top: 20px;
        font-size: 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        cursor: pointer;
    ">‚úñ Chiudi</button>
</div>






<!-- Bottone per aprire il popup -->
<div style="margin-top: 10px;">
  <button onclick="apriPopup30Giri()" style="background-color: #28a745; color: white; font-weight: bold; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer;">
    Mostra ultimi 30 arrivi
  </button>
</div>

<!-- Popup overlay per 30 giri -->
<div id="popupOverlay30" onclick="chiudiPopup30()" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 999;
"></div>

<div id="popup30" style="
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 12px;
    z-index: 1000;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
">
  <h3>Ultimi 30 giri</h3>
  <table class="latest-karts-table">
    <thead>
      <tr><th>NR</th><th>Pilota</th><th>Tempo</th></tr>
    </thead>
    <tbody id="ultimi30Body"></tbody>
  </table>
  <button onclick="chiudiPopup30()" class="btn-chiudi-popup">‚úñ Chiudi</button>
</div>


			
			
        </div>
    </div>

    <!-- üìå Campo di ricerca pilota allineato a sinistra -->
    <div class="search-container">
        <label for="searchPilotInput">Cerca Pilota:</label>
        <input type="number" id="searchPilotInput" placeholder="Inserisci numero pilota">
        <button onclick="cercaPilota()">Cerca</button>
    </div>

    <!-- üìå Messaggio informativo sotto il titolo -->
    <p class="info-click-tempi">Utilizza la funzione di ricerca oppure clicca il tuo numero nella CLASSIFICA GENERALE e visualizza i tuoi tempi!</p>



<!-- TAB SELEZIONE -->
<div class="tab-container" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">

  <!-- Riga PS -->
  <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; width: 100%;">
    <button class="tab-button ps" onclick="apriTab('ps1')">PS1</button>
    <button class="tab-button ps" onclick="apriTab('ps2')">PS2</button>
    <button class="tab-button ps" onclick="apriTab('ps3')">PS3</button>
    <button class="tab-button ps" onclick="apriTab('ps4')">PS4</button>
    <button class="tab-button ps" onclick="apriTab('ps5')">PS5</button>
    <button class="tab-button ps" onclick="apriTab('ps6')">PS6</button>
    <button class="tab-button ps" onclick="apriTab('ps7')">PS7</button>
    <button class="tab-button ps" onclick="apriTab('ps8')">PWR Stage</button>
  </div>

  <!-- Riga Classifiche Generale, Team, Donne, Senior -->
  <div style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; width: 100%;">
    <button class="tab-button generale active" onclick="apriTab('generale')">Classifica Generale</button>
    <button class="tab-button team" onclick="apriTab('team')">Team</button>
    <button class="tab-button donne" onclick="apriTab('donne')">Donne</button>
    <button class="tab-button senior" onclick="apriTab('senior')">Senior</button>
  </div>

</div>









    <!-- üìå Popup per i tempi del concorrente -->
<div id="popupOverlay" onclick="chiudiPopup()"></div>

<div id="popup">
    <h3 id="popupTitle"></h3>
    <div id="popupPunti" class="punteggio-popup"></div>

    <table>
        <thead>
            <tr>
                <th>Gara</th>
                <th>Posizione</th>
                <th>Tempo</th>
                <th>Delta</th>
            </tr>
        </thead>
        <tbody id="popupBody"></tbody>
    </table>
	<div id="popupDettagli"></div>
    <button onclick="chiudiPopup()" class="btn-chiudi-popup">‚úñ Chiudi</button>


</div>







    <!-- CLASSIFICA GENERALE -->
    <div id="generale" class="tab-content active">
        <h2>Classifica Generale</h2>
        <table>
            <thead>
    <tr>
        <th>Pos</th>
        <th>NR</th>
        <th>Nome</th>
        <th>Cognome</th>
        <th>Tempo</th>
        <th>Punti</th>
        <th>Giri</th>
        <th>Team</th>
        <th>C</th>
    </tr>
</thead>
            <tbody id="classificaGeneraleBody"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA TEAM -->
    <div id="team" class="tab-content">
        <h2>Classifica Team</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Team</th>
                    <th>Punti</th>
                </tr>
            </thead>
            <tbody id="classificaTeamBody"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA GENERALE -->
    <div id="donne" class="tab-content">
        <h2>Classifica Donne</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Giri</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaGeneraleBodyD"></tbody>
        </table>
    </div>
    <!-- CLASSIFICA GENERALE -->
    <div id="senior" class="tab-content">
        <h2>Classifica Senior</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Giri</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaGeneraleBodyS"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps1" class="tab-content">
        <h2>Classifica PS1</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS1Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps2" class="tab-content">
        <h2>Classifica PS2</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS2Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps3" class="tab-content">
        <h2>Classifica PS3</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS3Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps4" class="tab-content">
        <h2>Classifica PS4</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS4Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps5" class="tab-content">
        <h2>Classifica PS5</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS5Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps6" class="tab-content">
        <h2>Classifica PS6</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS6Body"></tbody>
        </table>
    </div>
	
	
    <!-- CLASSIFICA PS1 -->
    <div id="ps7" class="tab-content">
        <h2>Classifica PS7</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS7Body"></tbody>
        </table>
    </div>

    <!-- CLASSIFICA PS1 -->
    <div id="ps8" class="tab-content">
        <h2>Classifica Power Stage</h2>
        <table>
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>NR</th>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Tempo</th>
                    <th>Team</th>
                    <th>C</th>
                </tr>
            </thead>
            <tbody id="classificaPS8Body"></tbody>
        </table>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Inizializza Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA4xpOxt0tbRHwIwAQkNkZ_403MHiEbJ_w",
            authDomain: "kartlive-4e0ca.firebaseapp.com",
            databaseURL: "https://kartlive-4e0ca-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "kartlive-4e0ca",
            storageBucket: "kartlive-4e0ca.appspot.com",
            messagingSenderId: "517645685489",
            appId: "1:517645685489:web:1e67912cba32a6f5b54f50"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        function apriTab(nomeTab) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab-button").forEach(button => button.classList.remove("active"));
            document.getElementById(nomeTab).classList.add("active");
            document.querySelector(`button[onclick="apriTab('${nomeTab}')"]`).classList.add("active");
        }

 function caricaClassificaGenerale() {
    console.log('üí° numeroGiroVeloce globale:', window.numeroGiroVeloce);
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaGeneraleBody");
        classificaBody.innerHTML = "";
        if (!snapshot.exists()) return;

        let dati = [];

        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            let tempo = parseInt(concorrente.Tempoms) || 0;
            let numeroGara = parseInt(concorrente.Gara);

            if (concorrente.Arrivato === "SI" && numeroGara > 0) {
                let esistente = dati.find(c => c.NumeroConcorrente === concorrente.NumeroConcorrente);
                if (esistente) {
                    esistente.SommaTempo += tempo;
                    esistente.NumeroGiri++;
                } else {
                    dati.push({
                        NumeroConcorrente: concorrente.NumeroConcorrente,
                        Nome: concorrente.Nome,
                        Cognome: concorrente.Cognome,
                        Categoria: concorrente.Categoria,
                        SommaTempo: tempo,
                        NumeroGiri: 1,
                        Squadra: concorrente.Squadra
                    });
                }
            }
        });

        dati.sort((a, b) =>
            b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo
        );

        const giriCompleti = [];
        snapshot.forEach(childSnapshot => {
            const g = childSnapshot.val();
            if (g.Arrivato === "SI" && !isNaN(Number(g.Tempoms)) && Number(g.Tempoms) > 0) {
                g.Tempoms = Number(g.Tempoms);
                giriCompleti.push(g);
            }
        });

        const punteggi = calcolaPuntiConcorrenti(dati, giriCompleti);

        // Mappa colori forzata per numero di giri
        const mappaColori = {
		    8: 'group-alt-0',
            7: 'group-alt-0',
            6: 'group-alt-0',
            5: 'group-alt-0',
            4: 'group-alt-0',
            3: 'group-alt-0',
            2: 'group-alt-0',
            1: 'group-alt-0'
        };

        classificaBody.innerHTML = dati.map((c, index) => {
            const isGiroVeloce = c.NumeroConcorrente === window.numeroGiroVeloce;
            const puntiPilota = punteggi[c.NumeroConcorrente] || {};
            const puntiTotaliFinali = puntiPilota.totale || 0;

            const categoriaClasse = c.Categoria === "OD" ? "concorrente-donna-senior" :
                                     c.Categoria === "D" ? "concorrente-donna" :
                                     c.Categoria === "O" ? "concorrente-senior" :
                                                           "concorrente-generale";

            const groupClass = mappaColori[c.NumeroGiri];

            let breakdown = "";
            if (
                (puntiPilota.extraDonne || 0) > 0 ||
                (puntiPilota.extraSenior || 0) > 0 ||
                (puntiPilota.ps || 0) > 0 ||
                puntiPilota.giroVeloce
            ) {
                breakdown = `= ${puntiPilota.gen || 0}`;
                if (puntiPilota.extraDonne) breakdown += ` + ${puntiPilota.extraDonne} üéÄ`;
                if (puntiPilota.extraSenior) breakdown += ` + ${puntiPilota.extraSenior} üë¥`;
                if (puntiPilota.ps) breakdown += ` + ${puntiPilota.ps} ‚ö°`;
                if (puntiPilota.giroVeloce) breakdown += ` + 10 ‚è±`;
            }

            return `
                <tr class="${groupClass}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}" onclick="apriPopupTempi(${c.NumeroConcorrente}, '${c.Nome}', '${c.Cognome}', '${c.Categoria}')">${c.NumeroConcorrente}</td>
                    <td class="bold-text">${c.Nome.length > 10 ? c.Nome.slice(0, 12) : c.Nome}</td>
                    <td class="bold-text">${c.Cognome.length > 10 ? c.Cognome.slice(0, 12) : c.Cognome}</td>
                    <td class="bold-text">${formattaTempo(c.SommaTempo)}${isGiroVeloce ? ' ‚è±' : ''}</td>
                    <td>
                        <span style="color: green; font-weight:bold;">
                            ${puntiTotaliFinali}pt${breakdown ? ' ' + breakdown : ''}
                        </span>
                    </td>
                    <td>${c.NumeroGiri}</td>
                    <td>${c.Squadra.length > 10 ? c.Squadra.slice(0, 12) : c.Squadra}</td>
                    <td>${c.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}














function calcolaPuntiConcorrenti(dati, giri) {
    const punti = {};
    const punteggioPosizione = [50, 45, 41, 38, 36, 34, 32, 30, 28, 26, 24, 22, 20, 18, 16,
                                 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1];

    // Classifica generale
    const classificaGenerale = [...dati];
    classificaGenerale.sort((a, b) =>
        b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo
    );

    classificaGenerale.forEach((c, index) => {
        const pt = punteggioPosizione[index] || 0;
        if (!punti[c.NumeroConcorrente]) punti[c.NumeroConcorrente] = {};
        punti[c.NumeroConcorrente].gen = pt;
    });

    // Classifica donne
    const donne = dati.filter(c => c.Categoria === "D" || c.Categoria === "OD");
    donne.sort((a, b) =>
        b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo
    );
    const puntiDonne = [15, 12, 10, 8, 6, 4, 3, 2, 1];
    donne.forEach((c, index) => {
        const pt = puntiDonne[index] || 0;
        if (!punti[c.NumeroConcorrente]) punti[c.NumeroConcorrente] = {};
        punti[c.NumeroConcorrente].extraDonne = pt;
    });

    // Classifica senior
    const senior = dati.filter(c => c.Categoria === "O" || c.Categoria === "OD");
    senior.sort((a, b) =>
        b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo
    );
    const puntiSenior = [10, 8, 6, 5, 4, 3, 2, 1];
    senior.forEach((c, index) => {
        const pt = puntiSenior[index] || 0;
        if (!punti[c.NumeroConcorrente]) punti[c.NumeroConcorrente] = {};
        punti[c.NumeroConcorrente].extraSenior = pt;
    });

    // Power Stage
    const powerStage = giri.filter(g => parseInt(g.Gara) === 8);
    const classificaPS = [];

    powerStage.forEach(g => {
        let c = classificaGenerale.find(d => d.NumeroConcorrente === g.NumeroConcorrente);
        if (!c) return;
        let esistente = classificaPS.find(p => p.NumeroConcorrente === g.NumeroConcorrente);
        if (esistente) {
            esistente.SommaTempo += g.Tempoms;
            esistente.NumeroGiri++;
        } else {
            classificaPS.push({
                NumeroConcorrente: g.NumeroConcorrente,
                SommaTempo: g.Tempoms,
                NumeroGiri: 1
            });
        }
    });

    classificaPS.sort((a, b) =>
        b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo
    );
    const puntiPS = [5, 4, 3, 2, 1];
    classificaPS.forEach((c, index) => {
        const pt = puntiPS[index] || 0;
        if (!punti[c.NumeroConcorrente]) punti[c.NumeroConcorrente] = {};
        punti[c.NumeroConcorrente].ps = pt;
    });

    // Giro pi√π veloce
    let giroVeloce = null;
    giri.forEach(g => {
        if (g.Arrivato === "SI" && g.Tempoms > 0) {
            if (!giroVeloce || g.Tempoms < giroVeloce.Tempoms) {
                giroVeloce = g;
            }
        }
    });

    if (giroVeloce && giroVeloce.NumeroConcorrente) {
        if (!punti[giroVeloce.NumeroConcorrente]) punti[giroVeloce.NumeroConcorrente] = {};
        punti[giroVeloce.NumeroConcorrente].giroVeloce = true;
    }

    // Calcolo totale
    for (const id in punti) {
        const p = punti[id];
        p.totale =
            (p.gen || 0) +
            (p.extraDonne || 0) +
            (p.extraSenior || 0) +
            (p.ps || 0) +
            (p.giroVeloce ? 10 : 0);
    }

    return punti;
}







        function formattaTempo(ms) {
            let min = Math.floor(ms / 60000);
            let sec = Math.floor((ms % 60000) / 1000);
            let milli = ms % 1000;
            return `${min}:${sec.toString().padStart(2, "0")}:${milli.toString().padStart(3, "0")}`;
        }



       function caricaClassificaTeam() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        if (!snapshot.exists()) return;

        const giri = Object.values(snapshot.val());
        let concorrenti = {};

        // Raggruppa giri per concorrente
        giri.forEach(g => {
            if (g.Arrivato === "SI" && parseInt(g.Gara) > 0) {
                const id = g.NumeroConcorrente;
                const team = g.Squadra || "Senza Team";
                const tempo = parseInt(g.Tempoms) || 0;

                if (!concorrenti[id]) {
                    concorrenti[id] = {
                        NumeroConcorrente: id,
                        Nome: g.Nome,
                        Cognome: g.Cognome,
                        Categoria: g.Categoria,
                        Squadra: team,
                        Giri: 0,
                        TempoTotale: 0
                    };
                }

                concorrenti[id].Giri++;
                concorrenti[id].TempoTotale += tempo;
            }
        });

        let classificaArray = Object.values(concorrenti).sort((a, b) =>
            b.Giri !== a.Giri ? b.Giri - a.Giri : a.TempoTotale - b.TempoTotale
        );

        const giriCompleti = [];
        snapshot.forEach(childSnapshot => {
            const g = childSnapshot.val();
            if (g.Arrivato === "SI" && !isNaN(parseInt(g.Tempoms))) {
                giriCompleti.push(g);
            }
        });

        const punteggi = calcolaPuntiConcorrenti(classificaArray, giriCompleti);

        // Calcolo punti totali team
        let teamPunti = {};
        classificaArray.forEach(c => {
            const pt = punteggi[c.NumeroConcorrente];
            if (pt && c.Squadra !== "SINGOLO") {
                teamPunti[c.Squadra] = (teamPunti[c.Squadra] || 0) + pt.totale;
            }
        });

        const classificaTeam = Object.entries(teamPunti).map(([team, punti]) => ({ team, punti }))
            .sort((a, b) => b.punti - a.punti);

        const classificaTeamBody = document.getElementById("classificaTeamBody");
        classificaTeamBody.innerHTML = "";

        classificaTeam.forEach((team, index) => {
            const pilotiDelTeam = classificaArray.filter(p => p.Squadra === team.team);

            const pilotiHTML = pilotiDelTeam
                .filter(p => punteggi[p.NumeroConcorrente]?.totale > 0)
                .map(p => {
                    const pt = punteggi[p.NumeroConcorrente];
                    const classe = p.Categoria === "D" ? "pilota-donne"
                                : p.Categoria === "O" ? "pilota-senior"
                                : p.Categoria === "OD" ? "pilota-od"
                                : "pilota-generale";

                    const dettagli = [];
                    if (pt.gen > 0) dettagli.push(`${pt.gen} gen`);
                    if (pt.extraDonne > 0) dettagli.push(`${pt.extraDonne} üéÄ`);
                    if (pt.extraSenior > 0) dettagli.push(`${pt.extraSenior} üë¥`);
                    if (pt.ps > 0) dettagli.push(`${pt.ps} ‚ö°`);
                    if (pt.giroVeloce) dettagli.push(`10 ‚è±`);

                    return `
                        <div class="team-pilot ${classe}">
                            <span class="numero">#${p.NumeroConcorrente}</span>
                            ${p.Nome} ${p.Cognome} ‚Üí 
                            <span class="punti-singolo">${pt.totale}pt${dettagli.length ? ` (${dettagli.join(" + ")})` : ""}</span>
                        </div>
                    `;
                }).join("");

            // ‚úÖ Usa contenitore separato per evitare che influisca sul font globale
            classificaTeamBody.innerHTML += `
                <tr>
                    <td class="team-position">${index + 1}</td>
                    <td class="team-name">
                        <div class="team-nome">${team.team}</div>
                        <div class="team-piloti-wrap">${pilotiHTML}</div>
                    </td>
                    <td class="punti-totali">${team.punti}</td>
                </tr>
            `;
        });
    });
}


        function caricaClassificaPS1() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS1Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 1) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
                  <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}



 function caricaClassificaPS2() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS2Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 2) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
                <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}


        function caricaClassificaPS3() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS3Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 3) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
                 <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}


 function caricaClassificaPS4() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS4Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 4) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
            <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}

function caricaClassificaPS5() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS5Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 5) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
                <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}



 function caricaClassificaPS6() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS6Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 6) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
                  <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";

            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}


function caricaClassificaPS7() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS7Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 7) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
              <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";
            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}

function caricaClassificaPS8() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaPS8Body");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && parseInt(concorrente.Gara) === 8) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                dati.push({
                    NumeroConcorrente: concorrente.NumeroConcorrente,
                    Nome: concorrente.Nome,
                    Cognome: concorrente.Cognome,
                    Tempo: tempo,
                    Squadra: concorrente.Squadra,
                    Categoria: concorrente.Categoria,
                    PFalsa: concorrente.PFalsa || "NO" // Prende anche PFalsa
                });
            }
        });

        dati.sort((a, b) => a.Tempo - b.Tempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            let categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" :
                                   concorrente.Categoria === "D" ? "concorrente-donna" :
                                   concorrente.Categoria === "O" ? "concorrente-senior" :
                                                                   "concorrente-generale";

            // Evidenzia partenza falsa se presente
            const partenzaFalsaBadge = concorrente.PFalsa === "SI" ? `
              <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">
                    üö© PF
                </span>` : "";
            // Sfondo riga rosso trasparente se PFalsa
            const bgStyle = concorrente.PFalsa === "SI" ? "background-color: rgba(255,0,0,0.2);" : "";

            return `
                <tr style="${bgStyle}">
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">
                        ${formattaTempo(concorrente.Tempo)}
                        ${partenzaFalsaBadge}
                    </td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}



        function caricaClassificaGeneraleD() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaGeneraleBodyD");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && (concorrente.Categoria === "D" || concorrente.Categoria === "OD")) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                let esistente = dati.find(c => c.NumeroConcorrente === concorrente.NumeroConcorrente);

                if (esistente) {
                    esistente.SommaTempo += tempo;
                    esistente.NumeroGiri++;
                } else {
                    dati.push({
                        NumeroConcorrente: concorrente.NumeroConcorrente,
                        Nome: concorrente.Nome,
                        Cognome: concorrente.Cognome,
                        Categoria: concorrente.Categoria,
                        SommaTempo: tempo,
                        NumeroGiri: 1,
                        Squadra: concorrente.Squadra
                    });
                }
            }
        });

        dati.sort((a, b) => b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            const categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" : "concorrente-donna";
            return `
                <tr>
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">${formattaTempo(concorrente.SommaTempo)}</td>
                    <td>${concorrente.NumeroGiri}</td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}


       function caricaClassificaGeneraleS() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        let classificaBody = document.getElementById("classificaGeneraleBodyS");
        classificaBody.innerHTML = "";

        if (!snapshot.exists()) return;

        let dati = [];
        snapshot.forEach((childSnapshot) => {
            let concorrente = childSnapshot.val();
            if (concorrente.Arrivato === "SI" && (concorrente.Categoria === "O" || concorrente.Categoria === "OD")) {
                let tempo = parseInt(concorrente.Tempoms) || 0;
                let esistente = dati.find(c => c.NumeroConcorrente === concorrente.NumeroConcorrente);

                if (esistente) {
                    esistente.SommaTempo += tempo;
                    esistente.NumeroGiri++;
                } else {
                    dati.push({
                        NumeroConcorrente: concorrente.NumeroConcorrente,
                        Nome: concorrente.Nome,
                        Cognome: concorrente.Cognome,
                        Categoria: concorrente.Categoria,
                        SommaTempo: tempo,
                        NumeroGiri: 1,
                        Squadra: concorrente.Squadra
                    });
                }
            }
        });

        dati.sort((a, b) => b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.SommaTempo - b.SommaTempo);

        classificaBody.innerHTML = dati.map((concorrente, index) => {
            const categoriaClasse = concorrente.Categoria === "OD" ? "concorrente-donna-senior" : "concorrente-senior";
            return `
                <tr>
                    <td class="posizione-generale">${index + 1}</td>
                    <td class="${categoriaClasse}">${concorrente.NumeroConcorrente}</td>
                    <td class="bold-text">${concorrente.Nome}</td>
                    <td class="bold-text">${concorrente.Cognome}</td>
                    <td class="bold-text">${formattaTempo(concorrente.SommaTempo)}</td>
                    <td>${concorrente.NumeroGiri}</td>
                    <td>${concorrente.Squadra}</td>
                    <td>${concorrente.Categoria}</td>
                </tr>
            `;
        }).join("");
    });
}



       function aggiornaGiroPiuVeloce() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        if (!snapshot.exists()) return;

        let giri = Object.values(snapshot.val()).filter(g => g.Arrivato === "SI" && Number(g.Tempoms) > 0);
        if (giri.length === 0) return;

        let giroPiuVeloce = giri.reduce((min, curr) =>
            Number(curr.Tempoms) < Number(min.Tempoms) ? curr : min
        );

        let nuovoNumero = giroPiuVeloce.NumeroConcorrente;

        if (window.numeroGiroVeloce !== nuovoNumero) {
            console.log("‚è± Miglior giro aggiornato:", nuovoNumero);
            window.numeroGiroVeloce = nuovoNumero;
            caricaClassificaGenerale();
        }

        // Mostra sempre anche in alto
        document.getElementById("fastestLapNR").innerText = giroPiuVeloce.NumeroConcorrente;
        document.getElementById("fastestLapPilot").innerText = `${giroPiuVeloce.Nome} ${giroPiuVeloce.Cognome}`;
        document.getElementById("fastestLapTime").innerText = formattaTempo(giroPiuVeloce.Tempoms);
    });
}




function aggiornaUltimi5KartArrivati() {
    const classificaRef = db.ref("giro");

    classificaRef.on("value", (snapshot) => {
        if (!snapshot.exists()) return;

        const tuttiGiri = Object.values(snapshot.val()).filter(g =>
            g.Arrivato === "SI" &&
            !isNaN(parseInt(g.Tempoms)) &&
            g.NumeroConcorrente !== undefined
        );

        const giriOrdinati = [...tuttiGiri].sort((a, b) => b.ID - a.ID);

        // Mostra ultimi 5 arrivi
        const ultimi5 = giriOrdinati.slice(0, 5);
        const latestKartsBody = document.getElementById("latestKartsBody");
        latestKartsBody.innerHTML = "";

        ultimi5.forEach(giro => {
            latestKartsBody.innerHTML += `
                <tr>
                    <td>${giro.NumeroConcorrente}</td>
                    <td>${giro.Nome} ${giro.Cognome}</td>
                    <td>${formattaTempo(giro.Tempoms)}</td>
                </tr>`;
        });

        // Mostra ultimi 30 giri
        const ultimi30Body = document.getElementById("ultimi30Body");
        if (ultimi30Body) {
            ultimi30Body.innerHTML = "";
            giriOrdinati.slice(0, 30).forEach(giro => {
                ultimi30Body.innerHTML += `
                    <tr>
                        <td>${giro.NumeroConcorrente}</td>
                        <td>${giro.Nome} ${giro.Cognome}</td>
                        <td>${formattaTempo(giro.Tempoms)}</td>
                    </tr>`;
            });
        }

        // Calcolo posizione nel popup solo se abbiamo almeno 1 arrivo
        if (ultimi5.length > 0) {
            const ultimo = ultimi5[0];
            const numeroUltimo = ultimo.NumeroConcorrente.toString();

            // === SOMMA DEI TEMPI PER OGNI PILOTA ===
            const sommaTempi = {};
            tuttiGiri.forEach(g => {
                const numero = g.NumeroConcorrente.toString();
                if (!sommaTempi[numero]) sommaTempi[numero] = 0;
                sommaTempi[numero] += parseInt(g.Tempoms);
            });

            // === CREA ARRAY CLASSIFICA ===
            const classifica = Object.entries(sommaTempi)
                .map(([numero, tempo]) => ({ numero, tempo }))
                .sort((a, b) => a.tempo - b.tempo);

            // === POSIZIONE GENERALE ===
            const posizioneGenerale = classifica.findIndex(p => p.numero === numeroUltimo) + 1;

            // === POSIZIONE PS CORRENTE ===
            const psGiri = tuttiGiri.filter(g =>
                g.Gara && parseInt(g.Gara) === parseInt(ultimo.Gara)
            );

            const classificaPS = psGiri
                .sort((a, b) => a.Tempoms - b.Tempoms)
                .map(g => g.NumeroConcorrente.toString());

            const posizionePS = classificaPS.indexOf(numeroUltimo) + 1;

            // === MOSTRA IL POPUP ===
            const nome = (ultimo.Nome || "").toString();
            const cognome = (ultimo.Cognome || "").toString();
            const categoria = (ultimo.Categoria || "").toString();

            apriPopupTempi(ultimo.NumeroConcorrente, nome, cognome, categoria);
        }
    });
}




        function assegnaPuntiGiroVeloce() {
            const classificaRef = db.ref("giro");

            classificaRef.once("value", (snapshot) => {
                if (!snapshot.exists()) {
                    console.error("‚ùå Nessun dato trovato!");
                    return;
                }

                let giri = snapshot.val();
                let migliorGiro = null;

                Object.values(giri).forEach(giro => {
                    if (giro.Arrivato === "SI") {
                        let tempo = parseInt(giro.Tempoms);
                        if (!migliorGiro || tempo < migliorGiro.tempo) {
                            migliorGiro = {
                                NumeroConcorrente: giro.NumeroConcorrente,
                                Nome: giro.Nome,
                                Cognome: giro.Cognome,
                                Squadra: giro.Squadra,
                                Tempo: tempo
                            };
                        }
                    }
                });

                if (migliorGiro && migliorGiro.Squadra !== "SINGOLO" && migliorGiro.Squadra) {
                    // Aggiungi 20 punti alla squadra del miglior giro
                    teamPunti[migliorGiro.Squadra] = (teamPunti[migliorGiro.Squadra] || 0) + 20;

                    // üî• Mostra un'indicazione accanto al nome della squadra nella Team
                    let classificaTeamBody = document.getElementById("classificaTeamBody");
                    let righe = classificaTeamBody.querySelectorAll("tr");

                    righe.forEach(riga => {
                        let nomeSquadra = riga.querySelector(".team-name");
                        if (nomeSquadra && nomeSquadra.innerText.includes(migliorGiro.Squadra)) {
                            nomeSquadra.innerHTML += ` <span style="color: red; font-size: 16px;">üî• +20pt Giro Veloce!</span>`;
                        }
                    });
                }
            });
        }

function apriPopupTempi(numeroConcorrente, nome = null, cognome = null, categoria = null) {
    const classificaRef = db.ref("giro");

    classificaRef.once("value", (snapshot) => {
        if (!snapshot.exists()) return;

        let datiGiri = [];
        let datiPerGara = {};
        let classificaGenerale = [];
        let classificaDonne = [];
        let classificaSenior = [];
        let giriCompleti = [];
        let categoriaPilota = categoria;

        // --- Raccolta dati ---
        snapshot.forEach((childSnapshot) => {
            let giro = childSnapshot.val();
            if (giro.Arrivato === "SI") {
                if (!datiPerGara[giro.Gara]) datiPerGara[giro.Gara] = [];
                datiPerGara[giro.Gara].push({
                    NumeroConcorrente: giro.NumeroConcorrente,
                    Tempo: parseInt(giro.Tempoms),
                    Gara: giro.Gara,
                    PFalsa: giro.PFalsa || "NO" // aggiunto PFalsa
                });

                giriCompleti.push(giro);

                if (giro.NumeroConcorrente == numeroConcorrente) {
                    if (!categoriaPilota) categoriaPilota = giro.Categoria;
                    if (!nome) nome = giro.Nome;
                    if (!cognome) cognome = giro.Cognome;
                }

                let esistente = classificaGenerale.find(c => c.NumeroConcorrente === giro.NumeroConcorrente);
                if (esistente) {
                    esistente.TempoTotale += parseInt(giro.Tempoms);
                    esistente.NumeroGiri++;
                } else {
                    classificaGenerale.push({
                        NumeroConcorrente: giro.NumeroConcorrente,
                        Nome: giro.Nome,
                        Cognome: giro.Cognome,
                        TempoTotale: parseInt(giro.Tempoms),
                        NumeroGiri: 1,
                        Categoria: giro.Categoria,
                        Squadra: giro.Squadra
                    });
                    if (giro.Categoria === "D" || giro.Categoria === "OD") classificaDonne.push(giro);
                    if (giro.Categoria === "O" || giro.Categoria === "OD") classificaSenior.push(giro);
                }
            }
        });

        const ordinaClassifica = (a, b) => b.NumeroGiri !== a.NumeroGiri ? b.NumeroGiri - a.NumeroGiri : a.TempoTotale - b.TempoTotale;
        classificaGenerale.sort(ordinaClassifica);
        classificaDonne.sort(ordinaClassifica);
        classificaSenior.sort(ordinaClassifica);

        const posizioneGenerale = classificaGenerale.findIndex(c => c.NumeroConcorrente == numeroConcorrente) + 1;
        const posizioneDonne = classificaDonne.findIndex(c => c.NumeroConcorrente == numeroConcorrente) + 1;
        const posizioneSenior = classificaSenior.findIndex(c => c.NumeroConcorrente == numeroConcorrente) + 1;

        Object.keys(datiPerGara).forEach(gara => {
            datiPerGara[gara].sort((a, b) => a.Tempo - b.Tempo);
            datiPerGara[gara].forEach((giro, index) => {
                giro.PosizioneGara = index + 1;
                if (giro.NumeroConcorrente == numeroConcorrente) {
                    datiGiri.push(giro);
                }
            });
        });

        const punteggi = calcolaPuntiConcorrenti(classificaGenerale, giriCompleti);
        const pt = punteggi[numeroConcorrente] || {};
        const totale = pt.totale || 0;

        const breakdown = [];
        if (pt.gen) breakdown.push(`${pt.gen} gen`);
        if (pt.extraDonne) breakdown.push(`${pt.extraDonne} üéÄ`);
        if (pt.extraSenior) breakdown.push(`${pt.extraSenior} üë¥`);
        if (pt.ps) breakdown.push(`${pt.ps} ‚ö°`);
        if (pt.giroVeloce) breakdown.push(`10 ‚è±`);

        const giriPilota = giriCompleti.filter(g => g.NumeroConcorrente == numeroConcorrente);
        const ultimoGiro = giriPilota[giriPilota.length - 1] || {};
        const tempoTotale = giriPilota.reduce((sum, g) => sum + parseInt(g.Tempoms), 0);
        const numeroGiri = giriPilota.length;
        const mediaGiro = numeroGiri ? tempoTotale / numeroGiri : 0;
        const migliorGiro = Math.min(...giriPilota.map(g => g.Tempoms));
        const peggiorGiro = Math.max(...giriPilota.map(g => g.Tempoms));
        const teamPilota = ultimoGiro.Squadra || "TEAM";

        let iconaCategoria = "";
        if (categoriaPilota === "D" || categoriaPilota === "OD") iconaCategoria += " üéÄ";
        if (categoriaPilota === "O" || categoriaPilota === "OD") iconaCategoria += " üë¥";

        const tempoUltimoGiro = formattaTempo(ultimoGiro.Tempoms || 0);
        const partenzaFalsaRiga = ultimoGiro.PFalsa === "SI" ? `
            <div style="
                color: yellow;
                background-color: black;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 22px;
                font-weight: bold;
                margin-top: 10px;
                display: inline-block;">
                üö© PARTENZA FALSA + 3 sec
            </div>` : "";

        const evidenzaArrivo = `
            <div style="
                font-size: 28px;
                font-weight: bold;
                background-color: #007bff;
                color: white;
                padding: 10px 20px;
                margin-bottom: 15px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.3);
                text-align: center;">
                üèÅ #${numeroConcorrente} ${nome} ${cognome} ‚Üí ${tempoUltimoGiro}
                ${partenzaFalsaRiga}
            </div>`;

        const riga2 = `<div style="font-size: 25px; font-weight:bold;">
            #${numeroConcorrente} ${nome} ${cognome} ‚Üí ${teamPilota}${iconaCategoria}
        </div>`;
        let riga3 = `<div style="margin-top: 5px; font-size: 22px;">
            <span style="color: red;">Pos. Gen: ${posizioneGenerale}</span>`;
        if (classificaDonne.some(c => c.NumeroConcorrente == numeroConcorrente)) {
            riga3 += ` - <span style="color: purple;">Pos. Donne: ${posizioneDonne}</span>`;
        }
        if (classificaSenior.some(c => c.NumeroConcorrente == numeroConcorrente)) {
            riga3 += ` - <span style="color: blue;">Pos. Senior: ${posizioneSenior}</span>`;
        }
        riga3 += `</div>`;

        document.getElementById("popupTitle").innerHTML = `${evidenzaArrivo}${riga2}${riga3}`;
        document.getElementById("popupPunti").innerHTML = `
            <span class="punteggio-popup">
                Punteggio: ${totale}pt ${breakdown.length ? `(${breakdown.join(" + ")})` : ""}
            </span>`;

        const mediaTroncata = Math.floor(mediaGiro);

        document.getElementById("popupDettagli").innerHTML = `
            <table style="margin-top: 10px; width: 100%; text-align: center;">
                <tr>
                    <th>Tempo Totale</th>
                    <th>Media Giro</th>
                    <th>Miglior Giro</th>
                    <th>Peggior Giro</th>
                    <th>Giri Completati</th>
                </tr>
                <tr>
                    <td>${formattaTempo(tempoTotale)}</td>
                    <td>${formattaTempo(mediaTroncata)}</td>
                    <td>${formattaTempo(migliorGiro)}</td>
                    <td>${formattaTempo(peggiorGiro)} üê¢</td>
                    <td>${numeroGiri}</td>
                </tr>
            </table>`;

        const migliorPos = Math.min(...datiGiri.map(g => g.PosizioneGara));
        const migliorGara = datiGiri.find(g => g.PosizioneGara === migliorPos)?.Gara || "-";
        document.getElementById("popupDettagli").innerHTML += `
            <div style="margin-top: 10px; text-align: center; font-size: 15px;">
                ü•á <strong>Miglior posizione:</strong> ${migliorPos}¬∞ (PS${migliorGara})
            </div>`;

        document.getElementById("popupBody").innerHTML = datiGiri.map(giro => {
            const tempiGara = datiPerGara[giro.Gara] || [];
            const migliorTempo = Math.min(...tempiGara.map(g => g.Tempo));
            const delta = giro.Tempo - migliorTempo;
            const deltaFormatted = giro.Tempo === migliorTempo ? "‚Äî" : `+${formattaTempo(delta)}`;
            const iconaGiro = giro.Tempo === migliorGiro ? " ‚è±" : giro.Tempo === peggiorGiro ? " üê¢" : "";
            const partenzaFalsaIcona = giro.PFalsa === "SI" ? `
                <span style="
                    color: yellow;
                    background-color: black;
                    padding: 2px 6px;
                    border-radius: 5px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: 6px;">üö© PFalsa</span>` : "";

            return `
                <tr>
                    <td>${giro.Gara}</td>
                    <td>${giro.PosizioneGara}</td>
                    <td>${formattaTempo(giro.Tempo)}${iconaGiro} ${partenzaFalsaIcona}</td>
                    <td>${deltaFormatted}</td>
                </tr>`;
        }).join("");

        document.getElementById("popup").style.display = "block";
        document.getElementById("popupOverlay").style.display = "block";

        setTimeout(() => {
            document.getElementById("popup").style.display = "none";
            document.getElementById("popupOverlay").style.display = "none";
        }, 5000);
    });
}














     function chiudiPopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("popupOverlay").style.display = "none";
}






        function formattaTempo(ms) {
            let min = Math.floor(ms / 60000);
            let sec = Math.floor((ms % 60000) / 1000);
            let milli = ms % 1000;
            return `${min}:${sec.toString().padStart(2, "0")}:${milli.toString().padStart(3, "0")}`;
        }

        function cercaPilota() {
            let numeroPilota = document.getElementById("searchPilotInput").value.trim();

            if (numeroPilota === "") {
                alert("Inserisci un numero pilota valido!");
                return;
            }

            const classificaRef = db.ref("giro");

            classificaRef.once("value", (snapshot) => {
                if (!snapshot.exists()) {
                    alert("Nessun dato trovato nel database!");
                    return;
                }

                let concorrenteTrovato = null;
                let categoriaConcorrente = "";
                snapshot.forEach((childSnapshot) => {
                    let giro = childSnapshot.val();
                    if (giro.Arrivato === "SI" && giro.NumeroConcorrente == numeroPilota) {
                        concorrenteTrovato = giro;
                        categoriaConcorrente = giro.Categoria;
                    }
                });

                if (!concorrenteTrovato) {
                    alert("Pilota non trovato!");
                    return;
                }

                apriPopupTempi(numeroPilota, concorrenteTrovato.Nome, concorrenteTrovato.Cognome, categoriaConcorrente);
            });
        }


function mostraPopupMobile(testo) {
    const popup = document.getElementById("mobilePopup");
    popup.textContent = testo;
    popup.style.display = "block";
    setTimeout(() => {
        popup.style.display = "none";
    }, 5000);
}

function toggleUltimi30() {
    const container = document.getElementById("ultimi30Container");
    container.style.display = container.style.display === "none" ? "block" : "none";
}

function apriPopup30Giri() {
    document.getElementById("popupOverlay30").style.display = "block";
    document.getElementById("popup30").style.display = "block";
}

function chiudiPopup30() {
    document.getElementById("popupOverlay30").style.display = "none";
    document.getElementById("popup30").style.display = "none";
}


let mobilePopupTimer = null;

function mostraPopupMobileConPosizione(giro, posizioneGenerale, posizionePS = null) {
    const popup = document.getElementById("mobilePopup");
    const popupContent = document.getElementById("popupContent");

    let testo = `#${giro.NumeroConcorrente} ${giro.Nome} ${giro.Cognome}<br>`;
    testo += `‚è± ${formattaTempo(giro.Tempoms)}<br>`;
    testo += `üèÅ Pos. Generale: ${posizioneGenerale}`;
    if (posizionePS !== null) {
        testo += `<br>‚ö° Pos. PS${giro.Gara}: ${posizionePS}`;
    }

    popupContent.innerHTML = testo;
    popup.style.display = "block";

    // Pulisce eventuali timer precedenti
    if (mobilePopupTimer) clearTimeout(mobilePopupTimer);
    mobilePopupTimer = setTimeout(() => {
        popup.style.display = "none";
    }, 8000);
}

function chiudiPopupMobile() {
    const popup = document.getElementById("mobilePopup");
    popup.style.display = "none";
    if (mobilePopupTimer) clearTimeout(mobilePopupTimer);
}





        // Carica le classifiche all'avvio

        caricaClassificaPS1();
        caricaClassificaPS2();
        caricaClassificaPS3();
        caricaClassificaPS4();
        caricaClassificaPS5();
        caricaClassificaPS6();
        caricaClassificaPS7();
		caricaClassificaPS8();
        
        caricaClassificaGeneraleD();
        caricaClassificaGeneraleS();
        caricaClassificaTeam();

        // üöÄ Avvia il caricamento dei dati
       aggiornaGiroPiuVeloce();
    caricaClassificaGenerale();

        aggiornaUltimi5KartArrivati();
    </script>





</body>
</html>
